<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skylands home page</title>

    <!-- fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <!-- css -->
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="menusidebar.css">
    <link rel="stylesheet" href="other.css">
    <link rel="stylesheet" href="auth.css">


    <!-- cloudflare turnstile (rCaptcha) -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

</head>
<body style="backdrop-filter: blur(10px);">

    <div class="container-main" style="border: none;">
        <h1 id="sectionTop" class="headline">Account page</h1>

        <div id="loggedInHide" style="width: 80%; max-width: 500px; min-width: 300px; justify-content: center;">
            <form id="loginForm" onsubmit="login(event)" class="auth-form">
                <p style="padding-bottom: 4%;">Don't have an account? <span onclick="toggleAuthForm()" class="link" style="font-size: large;">>>>Register</span></p>
                <input id="loginEmail" type="text" placeholder="Enter your email" class="form-input">
                <input id="loginPassword" type="password" placeholder="Enter your password" class="form-input">
                <button id="loginSubmit" type="submit" class="form-button">Login</button>
                <!-- Cloudflare Turnstile widget -->
                <div class="cf-turnstile" data-sitekey="0x4AAAAAABD2BIw2dkmjNzXs"></div>
            </form>

            <form id="registerForm" onsubmit="register(event)" class="auth-form" style="display: none;">
                <p style="padding-bottom: 4%;">Already have an account? <span onclick="toggleAuthForm()" class="link" style="font-size: large;">>>>Login</span></p>
                <input id="registerEmail" type="text" placeholder="Enter your email" class="form-input">
                <input id="emailVerificationCode" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Email code" class="form-input" style="width: 50%;">
                <button id="codeButton" type="button" onclick="verificationEmail()" class="form-button" style="width: 30%;">Send code</button>
                <input id="registerPassword" type="password" placeholder="Enter your password" class="form-input">
                <input id="registerPasswordConfirmation" type="password" placeholder="Confirm your pasword" class="form-input">
                <button id="registerSubmit" type="submit" class="form-button">Register</button>
                <!-- Cloudflare Turnstile widget -->
                <div class="cf-turnstile" data-sitekey="0x4AAAAAABD2BIw2dkmjNzXs"></div>
            </form>
        </div>




        <div id="instructions" class="container-text redAnimation">
            
        </div>

        <div id="loggedInShow" style="display:none">
            you are logged in
        </div>




    </div>


<script src="globalVariables.js"></script>



    <script>
        


        function instructions(text){
            const element = document.getElementById('instructions');
            element.innerText = text;
        }
        function toggleAuthForm() {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
    
            const loginVisible = loginForm.style.display !== 'none';
            if (loginVisible) {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
    
                instructions(
                    `
                    Purchase something after you create your account.
                    Accounts without any purchase will be automatically deleted after 48h.
                    `
                );
            } else {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
    
                instructions("");
            }
        }
        function blinkInput(id) {
            document.getElementById(id).style.backgroundColor = 'tomato';
            
            setTimeout(() => {
                document.getElementById(id).style.backgroundColor = 'white';
            }, 200);
            
            setTimeout(() => {
                document.getElementById(id).style.backgroundColor = 'tomato';
            }, 400);
        }
    
        function buttonCooldown( id, time = 4){
            const button = document.getElementById(id);
            const originalText = button.textContent;
            const originalColor = button.style.backgroundColor;
    
            button.disabled = true;
            button.textContent= `wait ${time}s`;
            button.style.backgroundColor= 'gray';
    
            const interval = setInterval(() => {
                time--;
                if (time > 0) {
                    button.textContent = `wait ${time}s`;
                } else {
                    clearInterval(interval);
                    button.disabled = false;
                    button.textContent = originalText;
                    button.style.backgroundColor = originalColor;
                }
            }, 1000);
        }
    
    </script>


<script>

    async function verificationEmail() {
//#region process inputs
        let fail=false;

        const email = document.getElementById("registerEmail").value.toLowerCase().replace(/\s+/g, '');
        document.getElementById("registerEmail").value = email;
        if(/^\S+@\S+\.\S+$/.test(email) && email != "" && email.length<40){
            document.getElementById("registerEmail").style.backgroundColor = 'white';
        } else {
            blinkInput("registerEmail");
            instructions(
                `
                Sorry, email address cannot be longer than 40 characters.
                `
            )
            fail=true;
        }

        if(fail) return;
//#endregion

//#region request
        const serverResponse = await fetch(globalThis.domain + "/verificationEmail", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ email }),
        });
//#endregion

console.log('Verification code requested');
buttonCooldown('codeButton',45);

        let response = await serverResponse.json();
        if (serverResponse.ok) {
            console.log("Verification email code response successful");
        } else {
            console.log("ERROR while requesting verification code:");
            console.log(response.message);
            alert("ERROR while requesting verification code: " +response.message);
        }
    }

    async function register(event) {
            event.preventDefault();

//#region process inputs
            let fail=false;

            const email = document.getElementById("registerEmail").value.toLowerCase().replace(/\s+/g, '');
            document.getElementById("registerEmail").value = email;
            if(/^\S+@\S+\.\S+$/.test(email) && email != "" && email.length<40){
                document.getElementById("registerEmail").style.backgroundColor = 'white';
            } else {
                blinkInput("registerEmail");
                fail=true;
            }

            const password = document.getElementById("registerPassword").value.replace(/\s+/g, '');
            document.getElementById("registerPassword").value = password;
            const registerPasswordConfirmation = document.getElementById("registerPasswordConfirmation").value.replace(/\s+/g, '');
            document.getElementById("registerPasswordConfirmation").value = registerPasswordConfirmation;
            if(password == registerPasswordConfirmation && password != "" && password.length<20){
                document.getElementById("registerPassword").style.backgroundColor = 'white';
                document.getElementById("registerPasswordConfirmation").style.backgroundColor = 'white';
            } else {
                blinkInput("registerPassword");
                blinkInput("registerPasswordConfirmation");
                fail=true;
            }

            const emailVerificationCode = document.getElementById("emailVerificationCode").value.replace(/\s+/g, '');
            document.getElementById("emailVerificationCode").value = emailVerificationCode;
            if(emailVerificationCode != ""){
                document.getElementById("emailVerificationCode").style.backgroundColor = 'white';
            } else {
                blinkInput("emailVerificationCode");
                fail=true;
            }
            if(fail) return;
//#endregion


//#region request + turnstyle
            const turnstileToken = turnstile.getResponse();

            const serverResponse = await fetch(globalThis.domain + "/register", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ email, password, emailVerificationCode, "cf-turnstile-response": turnstileToken }),
            });
//#endregion

console.log('Register requested');
buttonCooldown('registerSubmit');

        let response = await serverResponse.json();
        if (serverResponse.ok) {
            if(response.message == email){
                globalThis.myEmail= email;
                globalThis.myPassword= password;
                document.getElementById('loggedInHide').style.display = 'none'; // when logged in hide this
                document.getElementById('loggedInShow').style.display = 'block'; // when logged in show this
                console.log("Register response successful");
                console.log("myEmail set to: " +globalThis.myEmail);
            }
        } else {
            console.log("ERROR while requesting register:");
            console.log(response.message);
            alert("ERROR while requesting register: " +response.message);
        }
    }



    async function login(event) {
        event.preventDefault();

// #region process inputs
        let fail=false;

        const email = document.getElementById("loginEmail").value.toLowerCase().replace(/\s+/g, '');
        document.getElementById("loginEmail").value = email;
        if(/^\S+@\S+\.\S+$/.test(email) && email != "" && email.length<40){
            document.getElementById("loginEmail").style.backgroundColor = 'white';
        } else {
            blinkInput("loginEmail");
            fail=true;
        }

        const password = document.getElementById("loginPassword").value.replace(/\s+/g, '');
        document.getElementById("loginPassword").value = password;
        if(password != "" && password.length<20){
            document.getElementById("loginPassword").style.backgroundColor = 'white';
        } else {
            blinkInput("loginPassword");
            fail=true;
        }

        if(fail) return;
//#endregion
        console.log('Login requested');
        buttonCooldown('loginSubmit');

//#region request + turnstyle
        const turnstileToken = turnstile.getResponse();

        const serverResponse = await fetch(globalThis.domain + "/login", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, password, "cf-turnstile-response": turnstileToken }),
        });
//#endregion

        let response = await serverResponse.json();
        if (serverResponse.ok) {
            if(response.message == email){
                globalThis.myEmail= email;
                globalThis.myPassword= password;
                document.getElementById('loggedInHide').style.display = 'none'; // when logged in hide this
                document.getElementById('loggedInShow').style.display = 'block'; // when logged in show this
                console.log("Login successful");
                console.log("myEmail set to: " +globalThis.myEmail);
            }
        } else {
            console.log("ERROR while requesting login:");
            console.log(response.message);
            alert("ERROR while requesting login: " +response.message);
        }
        
    }



</script>

</body>